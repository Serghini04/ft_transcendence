# ============================================================================
# ModSecurity Override Configuration
# This file overrides the base image's ModSecurity settings
# ============================================================================

# Enable ModSecurity
SecRuleEngine On

# ============================================================================
# Request Body Handling
# ============================================================================
SecRequestBodyAccess On
SecRequestBodyLimit 13107200          # 12.5 MB
SecRequestBodyNoFilesLimit 131072     # 128 KB for non-file uploads
SecRequestBodyLimitAction Reject

# ============================================================================
# Response Body Handling
# ============================================================================
SecResponseBodyAccess On
SecResponseBodyMimeType text/plain text/html text/xml application/json application/javascript
SecResponseBodyLimit 524288           # 512 KB
SecResponseBodyLimitAction ProcessPartial

# ============================================================================
# File Upload Handling
# ============================================================================
SecTmpDir /tmp/modsecurity/
SecDataDir /tmp/modsecurity/
SecUploadDir /tmp/modsecurity/upload/
SecUploadKeepFiles Off
SecUploadFileMode 0600

# ============================================================================
# Audit Logging
# ============================================================================
SecAuditEngine RelevantOnly
SecAuditLogRelevantStatus "^(?:5|4(?!04))"
SecAuditLogParts ABCFHZ
SecAuditLogType Serial
SecAuditLog /var/log/modsec/audit.log

# Also log to stdout for Docker container logs
SecAuditLog2 /dev/stdout

# ============================================================================
# Debug Logging
# ============================================================================
SecDebugLog /var/log/modsec/debug.log
# Set to 3 for production (logs warnings and errors)
# Set to 9 for troubleshooting (very verbose)
SecDebugLogLevel 3

# ============================================================================
# PCRE Limits (prevent ReDoS attacks)
# ============================================================================
SecPcreMatchLimit 100000
SecPcreMatchLimitRecursion 100000

# ============================================================================
# Miscellaneous Settings
# ============================================================================
SecArgumentSeparator &
SecCookieFormat 0
SecStatusEngine On

# ============================================================================
# Collection Timeout
# ============================================================================
SecCollectionTimeout 600

# ============================================================================
# Include Custom Rules
# CRITICAL: This MUST be enabled for custom rules to work
# ============================================================================
Include /etc/modsecurity.d/custom-rules/*.conf

# ============================================================================
# Rule Exclusions (add specific exclusions as needed)
# ============================================================================
# Example: Exclude specific rules for specific paths
# SecRuleRemoveById 920420
# SecRuleRemoveByTag "attack-protocol"