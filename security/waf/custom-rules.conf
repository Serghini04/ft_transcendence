# ============================================================================
# Custom ModSecurity Rules for Application
# Version: 1.0
# Optimized for ModSecurity v3 with OWASP CRS
# Last Updated: 2024
# ============================================================================

# ============================================================================
# SQL Injection Protection
# Detects SQL injection attempts using ModSecurity's built-in detection
# ============================================================================
SecRule ARGS "@detectSQLi" \
    "id:9000001,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'SQL Injection Attack Detected',\
    logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
    tag:'application-attack',\
    tag:'sqli',\
    tag:'OWASP_CRS',\
    severity:'CRITICAL',\
    ver:'CUSTOM/1.0',\
    maturity:'9',\
    accuracy:'9'"

# ============================================================================
# Cross-Site Scripting (XSS) Protection
# Detects XSS attempts using ModSecurity's built-in detection
# ============================================================================
SecRule ARGS "@detectXSS" \
    "id:9000002,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'XSS Attack Detected',\
    logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
    tag:'application-attack',\
    tag:'xss',\
    tag:'OWASP_CRS',\
    severity:'CRITICAL',\
    ver:'CUSTOM/1.0',\
    maturity:'9',\
    accuracy:'9'"

# ============================================================================
# Path Traversal Protection
# Blocks attempts to access files outside the web root using ../ or ..\
# ============================================================================
SecRule REQUEST_URI "@rx \.\.[/\\]" \
    "id:9000003,\
    phase:1,\
    deny,\
    status:403,\
    log,\
    msg:'Path Traversal Attack Detected',\
    logdata:'URI: %{REQUEST_URI}',\
    tag:'application-attack',\
    tag:'path-traversal',\
    severity:'CRITICAL',\
    ver:'CUSTOM/1.0',\
    maturity:'9',\
    accuracy:'9'"

# ============================================================================
# SQL Keywords in Suspicious Context
# Detects common SQL keywords that appear in attack patterns
# ============================================================================
SecRule REQUEST_URI|ARGS|REQUEST_BODY "@rx (?i:(\bunion\b.+\bselect\b|\binsert\b.+\binto\b|\bdelete\b.+\bfrom\b|\bdrop\b.+\btable\b|\bexec\b|\bexecute\b|\bupdate\b.+\bset\b))" \
    "id:9000004,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'SQL Keywords in Suspicious Pattern Detected',\
    logdata:'Matched Data: %{MATCHED_VAR}',\
    tag:'application-attack',\
    tag:'sqli',\
    severity:'WARNING',\
    ver:'CUSTOM/1.0',\
    maturity:'8',\
    accuracy:'8'"

# ============================================================================
# Malicious Scanner User-Agent Detection
# Blocks known security scanning tools and malicious crawlers
# ============================================================================
SecRule REQUEST_HEADERS:User-Agent "@rx (?i:^(sqlmap|nikto|nmap|masscan|acunetix|nessus|metasploit|w3af|dirbuster|havij|pangolin|webinspect|burp|zap|vega))" \
    "id:9000005,\
    phase:1,\
    deny,\
    status:403,\
    log,\
    msg:'Malicious Scanner User-Agent Detected',\
    logdata:'User-Agent: %{MATCHED_VAR}',\
    tag:'security-scanner',\
    tag:'automation',\
    severity:'WARNING',\
    ver:'CUSTOM/1.0',\
    maturity:'9',\
    accuracy:'9'"

# ============================================================================
# Rate Limiting Configuration
# Protects against DoS attacks by limiting requests per IP
# Allows 100 requests per 60 seconds per IP address
# ============================================================================

# Initialize IP collection for tracking request counts
SecAction \
    "id:9000006,\
    phase:1,\
    nolog,\
    pass,\
    initcol:ip=%{REMOTE_ADDR}"

# Increment request count on every request and set expiration
SecAction \
    "id:9000007,\
    phase:1,\
    nolog,\
    pass,\
    setvar:ip.request_count=+1,\
    expirevar:ip.request_count=60"

# Block requests if rate limit is exceeded
SecRule IP:REQUEST_COUNT "@gt 100" \
    "id:9000008,\
    phase:1,\
    deny,\
    status:429,\
    log,\
    msg:'Rate Limit Exceeded: %{ip.request_count} requests in 60 seconds',\
    logdata:'IP: %{REMOTE_ADDR}, Count: %{ip.request_count}',\
    tag:'dos-protection',\
    tag:'rate-limiting',\
    severity:'WARNING',\
    ver:'CUSTOM/1.0'"

# ============================================================================
# Command Injection Protection
# Blocks shell command injection attempts while allowing legitimate use
# Allows $ for prices/currency but blocks shell syntax like $(cmd) and ${var}
# ============================================================================
SecRule ARGS "@rx [;&|`]|\$\(|\$\{|<\(|>\(" \
    "id:9000009,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'Command Injection Pattern Detected',\
    logdata:'Matched Data: %{MATCHED_VAR} in %{MATCHED_VAR_NAME}',\
    tag:'application-attack',\
    tag:'command-injection',\
    severity:'CRITICAL',\
    ver:'CUSTOM/1.0',\
    maturity:'8',\
    accuracy:'8'"

# ============================================================================
# HTTP Method Validation
# Only allows standard HTTP methods, blocks unusual or custom methods
# ============================================================================
SecRule REQUEST_METHOD "!@within GET HEAD POST PUT DELETE PATCH OPTIONS" \
    "id:9000010,\
    phase:1,\
    deny,\
    status:405,\
    log,\
    msg:'Invalid HTTP Method',\
    logdata:'Method: %{REQUEST_METHOD}',\
    tag:'protocol-violation',\
    tag:'http-policy',\
    severity:'WARNING',\
    ver:'CUSTOM/1.0',\
    maturity:'9',\
    accuracy:'9'"

# ============================================================================
# Null Byte Attack Protection
# Blocks null bytes which can be used to bypass security checks
# ============================================================================
SecRule REQUEST_URI|ARGS|REQUEST_HEADERS "@validateByteRange 1-255" \
    "id:9000011,\
    phase:1,\
    deny,\
    status:403,\
    log,\
    msg:'Null Byte Attack Detected',\
    logdata:'Matched in: %{MATCHED_VAR_NAME}',\
    tag:'application-attack',\
    tag:'evasion',\
    severity:'CRITICAL',\
    ver:'CUSTOM/1.0',\
    maturity:'9',\
    accuracy:'9'"

# ============================================================================
# LDAP Injection Protection
# Detects LDAP injection attempts in parameters
# ============================================================================
SecRule ARGS "@rx [()=*|&]" \
    "id:9000012,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'Potential LDAP Injection Detected',\
    logdata:'Matched Data: %{MATCHED_VAR} in %{MATCHED_VAR_NAME}',\
    tag:'application-attack',\
    tag:'ldap-injection',\
    severity:'WARNING',\
    ver:'CUSTOM/1.0',\
    maturity:'7',\
    accuracy:'7'"

# ============================================================================
# Webshell Pattern Detection
# Blocks common PHP/code execution functions used in webshells
# ============================================================================
SecRule REQUEST_URI|ARGS "@rx (?i:(eval\(|base64_decode|gzinflate|gzuncompress|assert\(|passthru|shell_exec|system\(|phpinfo\(|exec\(|popen\(|proc_open))" \
    "id:9000013,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'Webshell Pattern Detected',\
    logdata:'Matched Data: %{MATCHED_VAR} in %{MATCHED_VAR_NAME}',\
    tag:'application-attack',\
    tag:'webshell',\
    tag:'code-injection',\
    severity:'CRITICAL',\
    ver:'CUSTOM/1.0',\
    maturity:'8',\
    accuracy:'8'"

# ============================================================================
# Dangerous File Upload Extension Blocking
# Prevents upload of executable files and scripts
# ============================================================================
SecRule FILES "@rx (?i:\.(php|phtml|php3|php4|php5|php7|phps|pht|phar|jsp|asp|aspx|asa|cer|sh|py|pl|cgi|exe|bat|cmd|vbs|ps1)$)" \
    "id:9000014,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'Dangerous File Upload Extension Detected',\
    logdata:'Filename: %{MATCHED_VAR}',\
    tag:'application-attack',\
    tag:'file-upload',\
    severity:'CRITICAL',\
    ver:'CUSTOM/1.0',\
    maturity:'9',\
    accuracy:'9'"

# ============================================================================
# Authentication Bypass Attempt Detection
# Detects SQL-based authentication bypass patterns
# ============================================================================
SecRule ARGS "@rx (?i:(admin|root|administrator|user)['\"]*\s*(=|like)\s*['\"]*\s*(or|and)\s+['\"]*\s*\d*\s*['\"]*\s*(=|like))" \
    "id:9000015,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'Authentication Bypass Attempt Detected',\
    logdata:'Matched Data: %{MATCHED_VAR} in %{MATCHED_VAR_NAME}',\
    tag:'application-attack',\
    tag:'auth-bypass',\
    tag:'sqli',\
    severity:'CRITICAL',\
    ver:'CUSTOM/1.0',\
    maturity:'8',\
    accuracy:'8'"

# ============================================================================
# Remote File Inclusion (RFI) Protection
# Blocks attempts to include remote files via http/https/ftp URLs
# ============================================================================
SecRule ARGS "@rx (?i:(http|https|ftp|php|data|glob|phar|file|zip):\/\/)" \
    "id:9000016,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'Remote File Inclusion Attempt Detected',\
    logdata:'Matched Data: %{MATCHED_VAR} in %{MATCHED_VAR_NAME}',\
    tag:'application-attack',\
    tag:'rfi',\
    severity:'CRITICAL',\
    ver:'CUSTOM/1.0',\
    maturity:'9',\
    accuracy:'8'"

# ============================================================================
# XML Injection Protection
# Detects XML-based injection attempts including XXE
# ============================================================================
SecRule REQUEST_BODY "@rx (?i:<!ENTITY|<!DOCTYPE|SYSTEM|PUBLIC)" \
    "id:9000017,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'XML Injection or XXE Attempt Detected',\
    logdata:'Matched Data: %{MATCHED_VAR}',\
    tag:'application-attack',\
    tag:'xml-injection',\
    tag:'xxe',\
    severity:'CRITICAL',\
    ver:'CUSTOM/1.0',\
    maturity:'8',\
    accuracy:'8'"

# ============================================================================
# Server-Side Template Injection (SSTI) Protection
# Detects template injection patterns
# ============================================================================
SecRule ARGS "@rx (?i:(\{\{|\}\}|<%|%>|\$\{.*\}))" \
    "id:9000018,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'Server-Side Template Injection Attempt Detected',\
    logdata:'Matched Data: %{MATCHED_VAR} in %{MATCHED_VAR_NAME}',\
    tag:'application-attack',\
    tag:'ssti',\
    severity:'CRITICAL',\
    ver:'CUSTOM/1.0',\
    maturity:'7',\
    accuracy:'7'"

# ============================================================================
# Session Fixation Protection
# Detects attempts to fixate session IDs
# ============================================================================
SecRule ARGS:PHPSESSID|ARGS:JSESSIONID|ARGS:ASPSESSIONID "@rx ^[a-zA-Z0-9]{26,}$" \
    "id:9000019,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'Session Fixation Attempt Detected',\
    logdata:'Session ID: %{MATCHED_VAR}',\
    tag:'application-attack',\
    tag:'session-fixation',\
    severity:'WARNING',\
    ver:'CUSTOM/1.0',\
    maturity:'7',\
    accuracy:'6'"

# ============================================================================
# NoSQL Injection Protection
# Detects MongoDB and other NoSQL injection patterns
# ============================================================================
SecRule ARGS "@rx (?i:(\$ne|\$gt|\$lt|\$gte|\$lte|\$eq|\$where|\$regex))" \
    "id:9000020,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'NoSQL Injection Attempt Detected',\
    logdata:'Matched Data: %{MATCHED_VAR} in %{MATCHED_VAR_NAME}',\
    tag:'application-attack',\
    tag:'nosql-injection',\
    severity:'CRITICAL',\
    ver:'CUSTOM/1.0',\
    maturity:'8',\
    accuracy:'8'"

# ============================================================================
# HTTP Header Injection Protection
# Detects CRLF injection attempts in headers
# ============================================================================
SecRule REQUEST_HEADERS "@rx (\r|\n|%0d|%0a)" \
    "id:9000021,\
    phase:1,\
    deny,\
    status:403,\
    log,\
    msg:'HTTP Header Injection Detected',\
    logdata:'Header: %{MATCHED_VAR_NAME}',\
    tag:'application-attack',\
    tag:'header-injection',\
    severity:'CRITICAL',\
    ver:'CUSTOM/1.0',\
    maturity:'9',\
    accuracy:'9'"

# ============================================================================
# Backup File Access Protection
# Blocks access to common backup file extensions
# ============================================================================
SecRule REQUEST_URI "@rx (?i:\.(bak|backup|old|temp|tmp|save|swp|~|copy)$)" \
    "id:9000022,\
    phase:1,\
    deny,\
    status:403,\
    log,\
    msg:'Backup File Access Attempt Detected',\
    logdata:'URI: %{REQUEST_URI}',\
    tag:'information-disclosure',\
    tag:'backup-files',\
    severity:'WARNING',\
    ver:'CUSTOM/1.0',\
    maturity:'9',\
    accuracy:'9'"

# ============================================================================
# Sensitive File Access Protection
# Blocks access to configuration and sensitive files
# ============================================================================
SecRule REQUEST_URI "@rx (?i:(\.env|\.git|\.svn|\.htaccess|\.htpasswd|web\.config|\.DS_Store|composer\.json|package\.json|\.npmrc))" \
    "id:9000023,\
    phase:1,\
    deny,\
    status:403,\
    log,\
    msg:'Sensitive File Access Attempt Detected',\
    logdata:'URI: %{REQUEST_URI}',\
    tag:'information-disclosure',\
    tag:'sensitive-files',\
    severity:'CRITICAL',\
    ver:'CUSTOM/1.0',\
    maturity:'9',\
    accuracy:'9'"

# ============================================================================
# Large Request Body Protection
# Blocks suspiciously large request bodies that might indicate attacks
# Note: This is a backup to nginx client_max_body_size
# ============================================================================
SecRule REQUEST_BODY "@gt 20971520" \
    "id:9000024,\
    phase:2,\
    deny,\
    status:413,\
    log,\
    msg:'Request Body Too Large',\
    logdata:'Size: %{MATCHED_VAR} bytes',\
    tag:'dos-protection',\
    tag:'resource-exhaustion',\
    severity:'WARNING',\
    ver:'CUSTOM/1.0'"

# ============================================================================
# Unicode/UTF-8 Evasion Protection
# Detects attempts to use Unicode encoding to evade filters
# ============================================================================
SecRule ARGS "@rx (%u[0-9a-fA-F]{4})" \
    "id:9000025,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'Unicode Evasion Attempt Detected',\
    logdata:'Matched Data: %{MATCHED_VAR}',\
    tag:'evasion',\
    tag:'encoding',\
    severity:'WARNING',\
    ver:'CUSTOM/1.0',\
    maturity:'8',\
    accuracy:'7'"

# ============================================================================
# End of Custom Rules
# Total Rules: 25
# Coverage: SQLi, XSS, RFI, LFI, Command Injection, Path Traversal, 
#           File Upload, Authentication Bypass, Rate Limiting, DoS Protection,
#           LDAP Injection, NoSQL Injection, XXE, SSTI, Header Injection,
#           Information Disclosure, Evasion Techniques
# ============================================================================